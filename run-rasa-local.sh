#!/bin/bash

# –ó–∞–ø—É—Å–∫ Rasa –ª–æ–∫–∞–ª—å–Ω–æ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Docker)

set -e

echo "üêç –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ Rasa"
echo "======================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã Rasa —Å—É—â–µ—Å—Ç–≤—É—é—Ç
if [ ! -f "app/rasa/domain.yml" ]; then
    echo "‚ùå –§–∞–π–ª app/rasa/domain.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞."
    exit 1
fi

echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Rasa"
echo ""

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –¥–∞–Ω–Ω—ã–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ rasa
if [ ! -L "app/rasa/data" ]; then
    ln -sf "$(pwd)/data" "app/rasa/data"
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é Rasa
cd app/rasa

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Rasa
if ! command -v rasa &> /dev/null; then
    echo "‚¨áÔ∏è Rasa –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    pip install rasa==3.6.13
fi

echo "üì¶ –®–∞–≥ 1: –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ Rasa..."
echo "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç..."

# –û–±—É—á–∞–µ–º –º–æ–¥–µ–ª—å
rasa train --domain domain.yml --data data/ --config config.yml

if [ $? -eq 0 ]; then
    echo "‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±—É—á–µ–Ω–∞!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏"
    exit 1
fi

echo ""
echo "üöÄ –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ Rasa —Å–µ—Ä–≤–µ—Ä–∞..."
echo "–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:5005"
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
export RASA_TELEMETRY_ENABLED=false
rasa run --enable-api --cors '*' --debug --port 5005
